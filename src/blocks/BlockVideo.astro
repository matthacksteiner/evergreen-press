---
const {
	source,
	url,
	file,
	options,
	thumbnail,
	ratioDesktop,
	ratioMobile,
	text,
	font,
	size,
	align,
	textcolor,
	Level,
	toggle,
	metadata,
} = Astro.props;
const hasOption = (option) => options.includes(option);

const autoplay = hasOption('autoplay');
const loop = hasOption('loop');
const muted = hasOption('muted');
const full = hasOption('full') ? 'h-screen object-cover' : null;
const controls = hasOption('controls');
const isYoutube = url.includes('youtube.com') || url.includes('youtu.be');
const isVimeo = url.includes('vimeo.com');
const thumb = thumbnail ? thumbnail.url : null;
const cursor = thumbnail ? 'cursor-pointer' : null;
const youtubeNoCookies = isYoutube
	? url
			.replace(
				'https://www.youtube.com/watch?v=',
				'https://www.youtube-nocookie.com/embed/'
			)
			.replace('https://youtu.be/', 'https://www.youtube-nocookie.com/embed/')
	: null;
const vimeoPlayer = isVimeo
	? url.replace('https://vimeo.com/', 'https://player.vimeo.com/video/')
	: null;
---

<div
	id={metadata?.identifier || undefined}
	class:list={['blockVideo', 'blocks', metadata?.classes]}
	{...metadata?.attributes}
>
	<div class="video-container">
		{
			source === 'remote' ? (
				isYoutube ? (
					<iframe
						src={`${youtubeNoCookies}?autoplay=${autoplay ? 1 : 0}&loop=${
							loop ? 1 : 0
						}&mute=${muted || autoplay ? 1 : 0}&controls=${
							controls ? 1 : 0
						}&dnt=1`}
						allow="autoplay; encrypted-media"
					/>
				) : isVimeo ? (
					<iframe
						src={`${vimeoPlayer}?dnt=1?autoplay=${autoplay ? 1 : 0}&loop=${
							loop ? 1 : 0
						}&muted=${muted || autoplay ? 1 : 0}&controls=${controls ? 1 : 0}`}
						frameborder="0"
						allow="autoplay; fullscreen"
					/>
				) : (
					<div class="error">
						<p class="text-red-500">
							Der Video-Link ist ungültig. Bitte überprüfe ihn.
						</p>
					</div>
				)
			) : (
				<video
					preload="none"
					id={`${file.identifier}`}
					muted={muted || autoplay}
					autoplay={autoplay}
					loop={loop}
					controls={controls}
					playsinline={autoplay}
					poster={thumb}
					class:list={[full, cursor, file.classes, 'w-full']}
				>
					<source data-src={file.url} type="video/mp4" />
				</video>
			)
		}
		<div
			class="text-content absolute left-2/4 top-2/4 z-[1] w-4/5 max-w-[75%] -translate-x-2/4 -translate-y-2/4"
		>
			{
				toggle ? (
					<Level
						set:html={text}
						class:list={[
							`title font--${size}`,
							`text--${textcolor}`,
							`text--${align}`,
						]}
					/>
				) : null
			}
		</div>
	</div>
</div>

<style lang="css" define:vars={{ ratioDesktop, ratioMobile, font }}>
	.title {
		font-family: var(--font);
	}

	iframe {
		@apply aspect-[var(--ratioMobile)] h-auto w-full lg:aspect-[var(--ratioDesktop)];
	}
	video {
		@apply w-full;
	}
</style>

<script define:vars={{ cursor }}>
	if (cursor) {
		document.addEventListener('DOMContentLoaded', function () {
			const video = document.querySelectorAll('video');

			video.forEach((item) => {
				item.addEventListener('click', (event) => {
					if (item.paused) {
						item.play();
					} else {
						item.pause();
					}
				});
			});
		});
	}
	document.addEventListener('DOMContentLoaded', function () {
		let lazyVideos = [].slice.call(document.querySelectorAll('video'));

		if ('IntersectionObserver' in window) {
			let lazyVideoObserver = new IntersectionObserver(function (entries) {
				entries.forEach(function (video) {
					if (video.isIntersecting) {
						for (let source in video.target.children) {
							let videoSource = video.target.children[source];
							if (
								typeof videoSource.tagName === 'string' &&
								videoSource.tagName === 'SOURCE'
							) {
								videoSource.src = videoSource.dataset.src;
							}
						}

						video.target.load();
						video.target.classList.remove('lazy');
						lazyVideoObserver.unobserve(video.target);
					}
				});
			});

			lazyVideos.forEach(function (lazyVideo) {
				lazyVideoObserver.observe(lazyVideo);
			});
		}
	});
</script>
