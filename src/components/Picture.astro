---
import { Image } from 'astro:assets';
const isProd = import.meta.env.PROD;
const netlifyDev = import.meta.env.NETLIFY_DEV;
const netlifyUrl = import.meta.env.NETLIFY_URL;

const baseUrl = isProd
	? netlifyUrl
	: netlifyDev
	? 'http://localhost:8888'
	: netlifyUrl;

const { src, urlFocus, urlFocusMobile, ...props } = Astro.props;
const [numeratorMobile, denominatorMobile] =
	props.ratioMobile === 'original'
		? [props.width, props.height]
		: props.ratioMobile.split('/');
const [numeratorDesktop, denominatorDesktop] =
	props.ratioDesktop === 'original'
		? [props.width, props.height]
		: props.ratioDesktop.split('/');
const ratioDesktop = Number(numeratorDesktop) / Number(denominatorDesktop);
const ratioMobile = Number(numeratorMobile) / Number(denominatorMobile);

const sourceMobile = props.ratioMobile === 'original' ? src : urlFocusMobile;
const sourceDesktop = props.ratioDesktop === 'original' ? src : urlFocus;

const span = props.span;
const backgroundContainer = props.backgroundContainer
	? props.backgroundContainer
	: 'container';

const imageWidth = (containerWidth) =>
	Math.round(containerWidth / 12) * Number(span);
const imageHeight = (imageWidth, ratio) => Math.round(imageWidth / ratio);

const imageWidthDesktop = imageWidth(
	backgroundContainer === 'container' ? 1840 : 2560
);

const imageWidthMobile = 335;
const imageHeightMobile = imageHeight(imageWidthMobile, ratioMobile);
const imageWidthDesktop1280 = imageWidth(1280);
const imageWidthDesktop1920 = imageWidth(1840);

const imageHeightDesktop = imageHeight(imageWidthDesktop, ratioDesktop);
const imageHeightDesktop1280 = imageHeight(imageWidthDesktop1280, ratioDesktop);
const imageHeightDesktop1920 = imageHeight(imageWidthDesktop1920, ratioDesktop);

interface Props {
	src: string;
	urlFocus: string;
	urlFocusMobile: string;
	width: number;
	height: number;
	alt: string;
	ratioMobile: string;
	ratioDesktop: string;
	span: string;
	positon: string;
	class: string;
	loading: 'eager' | 'lazy';
	backgroundContainer: string;
}
---

{
	isProd || netlifyDev ? (
		<picture>
			<source
				srcset={`${baseUrl}/.netlify/images?url=${sourceMobile}&w=${imageWidthMobile}&h=${imageHeightMobile}&fit=cover 1x, ${baseUrl}/.netlify/images?url=${sourceMobile}&w=${imageWidthMobile}&h=${imageHeightMobile}&fit=cover 2x, ${baseUrl}/.netlify/images?url=${sourceMobile}&w=${imageWidthMobile}&h=${imageHeightMobile}&fit=cover 3x`}
				media="(max-width: 768px)"
			/>
			<source
				srcset={`${baseUrl}/.netlify/images?url=${sourceDesktop}&w=${imageWidthDesktop1280}&h=${imageHeightDesktop1280}&fit=cover, ${baseUrl}/.netlify/images?url=${sourceDesktop}&w=${imageWidthDesktop1280}&h=${imageHeightDesktop1280}&fit=cover 2x, ${baseUrl}/.netlify/images?url=${sourceDesktop}&w=${imageWidthDesktop1280}&h=${imageHeightDesktop1280}&fit=cover 3x`}
				media="(min-width: 769px) and (max-width: 1280px)"
			/>
			<source
				srcset={`${baseUrl}/.netlify/images?url=${sourceDesktop}&w=${imageWidthDesktop1920}&h=${imageHeightDesktop1920}&fit=cover, ${baseUrl}/.netlify/images?url=${sourceDesktop}&w=${imageWidthDesktop1920}&h=${imageHeightDesktop1920}&fit=cover 2x, ${baseUrl}/.netlify/images?url=${sourceDesktop}&w=${imageWidthDesktop1920}&h=${imageHeightDesktop1920}&fit=cover 3x`}
				media="(min-width: 1281px) and (max-width: 1920px)"
			/>

			<source
				srcset={`${baseUrl}/.netlify/images?url=${sourceDesktop}&w=${imageWidthDesktop}&h=${imageHeightDesktop}&fit=cover, ${baseUrl}/.netlify/images?url=${sourceDesktop}&w=${imageWidthDesktop}&h=${imageHeightDesktop}&fit=cover 2x, ${baseUrl}/.netlify/images?url=${sourceDesktop}&w=${imageWidthDesktop}&h=${imageHeightDesktop}&fit=cover 3x`}
				media="(min-width: 1921px)"
			/>
			<img
				src={`${baseUrl}/.netlify/images?url=${sourceDesktop}&w=${imageWidthDesktop}&h=${imageHeightDesktop}&fit=cover&fm=jpg&q=80`}
				width={imageWidthDesktop}
				height={imageHeightDesktop}
				alt={props.alt}
				loading={props.loading}
				class={props.class}
			/>
		</picture>
	) : (
		<>
			<Image
				src={sourceMobile}
				{...props}
				width={imageWidthMobile}
				height={imageHeightMobile}
				class={`lg:hidden ${props.class}`}
			/>

			<Image
				src={sourceDesktop}
				width={imageWidthDesktop}
				height={imageHeightDesktop}
				{...props}
				class={`hidden lg:block ${props.class}`}
			/>
		</>
	)
}
