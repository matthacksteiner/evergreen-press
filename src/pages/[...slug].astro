---
import { getGlobal, getData, getLanguages } from '@lib/api.js';
import BaseLayout from '@layouts/BaseLayout.astro';
import Layouts from '@components/Layouts.astro';

export async function getStaticPaths() {
	const API_URL = import.meta.env.KIRBY_URL;
	const languages = await getLanguages();
	const allLang = languages.allLang.map(({ code }) => code);

	if (allLang.length < 2) {
		const pagesResponse = await fetch(API_URL + '/index.json');
		const data = await pagesResponse.json();
		return data.map((item) => {
			return {
				params: {
					slug: item.uri,
				},
			};
		});
	} else {
		const paths = (
			await Promise.all(
				allLang.map(async (language) => {
					const pagesResponse = await fetch(
						API_URL + '/' + language + '/index.json'
					);
					const data = await pagesResponse.json();
					return data.map(({ uri }) => ({
						params: {
							slug: language + '/' + uri,
						},
						props: { language },
					}));
				})
			)
		).flat();
		return paths;
	}
}

const { slug } = Astro.params;
const language = Astro.props;
const global = language?.lang
	? await getData(`/${language.lang}/global.json`)
	: await getGlobal();
const data = language?.lang
	? await getData(`/${language.lang}/${slug}.json`)
	: await getData(`/${slug === undefined ? 'home' : slug}.json`);
const pageTitle = data.title;
---

<BaseLayout pageTitle={pageTitle} data={data} global={global}>
	<Layouts layouts={data.layouts} data={data} global={global} />
</BaseLayout>
