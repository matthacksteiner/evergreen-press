---
import { getGlobal } from '@lib/api.js';
import BaseLayout from '@layouts/BaseLayout.astro';
import Templates from '@components/Templates.astro';
import Layouts from '@components/Layouts.astro';
const API_URL = import.meta.env.KIRBY_URL;

export async function getStaticPaths() {
	const API_URL = import.meta.env.KIRBY_URL;
	const pagesResponse = await fetch(API_URL + '/index.json');
	const data = await pagesResponse.json();
	return data.map((item) => {
		return {
			params: {
				slug: item.uri === 'home' ? undefined : item.uri,
			},
			props: {
				template: item.intendedTemplate,
			},
		};
	});
}

const { slug } = Astro.params;
const { template } = Astro.props;
const pagesResponse = await fetch(
	API_URL + '/' + `${slug === undefined ? 'home' : slug}` + '.json'
);
if (!pagesResponse) throw Astro.redirect('/404');
const data = await pagesResponse.json();
const global = await getGlobal();
const pageTitle = data.title;
---

<BaseLayout pageTitle={pageTitle} data={data} global={global}>
	{
		template === 'section' ? (
			<Templates data={data} global={global} template={template} />
		) : (
			<Layouts layouts={data.layouts} data={data} global={global} />
		)
	}
</BaseLayout>
