---
import PageRenderer from '@components/PageRenderer.astro';
import { getPage, getData, type GlobalData } from '@lib/api';

export async function getStaticPaths({ paginate }) {
	const API_URL = import.meta.env.KIRBY_URL;
	const global = await getData<GlobalData>(`/global.json`);
	const elements = global.paginationElements;
	const prefixDefaultLocale = global.prefixDefaultLocale;
	const languages: GlobalData = await getData<GlobalData>(`/global.json`);
	const allLang = !prefixDefaultLocale
		? Object.values(languages.translations).map(
				(lang: Record<string, any>) => lang.code
		  )
		: languages.allLang.map(String);

	let paths: Array<{ params: { lang: string; section: string }; props: any }> =
		[];
	for (const lang of allLang) {
		const pagesResponse = await fetch(API_URL + '/' + lang + '/index.json');
		const data = await pagesResponse.json();
		const sections = data.filter((item) => item.intendedTemplate === 'section');
		for (const section of sections) {
			const itemsResponse = await fetch(
				API_URL + '/' + lang + `/${section.uri}.json`
			);
			const itemsData = await itemsResponse.json();
			const filteredItems = itemsData.items.filter(
				(item) => item.parent === section.uri
			);
			paths.push(
				...paginate(filteredItems, {
					params: { lang, section: section.uri },
					pageSize: elements,
				})
			);
		}
	}
	return paths;
}

const { page } = Astro.props;
const { lang, section } = Astro.params;
const global = await getData<GlobalData>(`/${lang}/global.json`);
---

<PageRenderer slug={section} lang={lang} page={page} global={global} />
