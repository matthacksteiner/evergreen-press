---
import { getGlobal, getData } from '@lib/api';
import BaseLayout from '@layouts/BaseLayout.astro';
import Section from '@components/Section.astro';

type Section = {
	uri: string;
	intendedTemplate: string;
};

type Item = {
	parent: string;
};

export async function getStaticPaths({ paginate }) {
	const global = await getGlobal();
	const elements = global.paginationElements;

	const API_URL = import.meta.env.KIRBY_URL;
	const pagesResponse = await fetch(API_URL + '/index.json');
	const data: Section[] = await pagesResponse.json();
	const sections = data.filter((item) => item.intendedTemplate === 'section');
	const sectionsSlug = sections.map((section) => section.uri);
	let allItems: Item[] = [];

	for (const section of sections) {
		const itemsResponse = await fetch(API_URL + `/${section.uri}.json`);
		const itemsData: { items: Item[] } = await itemsResponse.json();
		allItems = allItems.concat(itemsData.items);
	}

	return sectionsSlug.flatMap((section) => {
		const filteredItems = allItems.filter((item) => item.parent === section);
		return paginate(filteredItems, { params: { section }, pageSize: elements });
	});
}

const global = await getGlobal();
const { page } = Astro.props;
const params = Astro.params;
const section = params.section;
const data = await getData(`/${section}.json`);
const pageTitle = data.title;
---

<BaseLayout pageTitle={pageTitle} data={data} global={global}>
	<Section data={data} page={page} global={global} />
</BaseLayout>
